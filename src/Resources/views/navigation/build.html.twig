{% extends '@SyliusAdmin/layout.html.twig' %}

{% block title %}{{ 'setono_sylius_navigation.ui.build_navigation'|trans }} {{ parent() }}{% endblock %}

{% block content %}
<div class="ui stackable grid">
    <div class="sixteen wide column">
        <div class="ui breadcrumb">
            <a href="{{ path('setono_sylius_navigation_admin_navigation_index') }}" class="section">{{ 'setono_sylius_navigation.ui.navigations'|trans }}</a>
            <i class="right angle icon divider"></i>
            <div class="section">{{ navigation.code }}</div>
            <i class="right angle icon divider"></i>
            <div class="active section">{{ 'setono_sylius_navigation.ui.build_manually'|trans }}</div>
        </div>
    </div>
</div>

<div class="ui stackable grid">
    <div class="ten wide column">
        <div class="ui segment">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 class="ui header" style="margin: 0;">
                    <i class="sitemap icon"></i>
                    {{ 'setono_sylius_navigation.ui.navigation_tree'|trans }}
                </h3>
                <div id="main-add-dropdown" class="ui primary button dropdown">
                    <i class="plus icon"></i>
                    {{ 'setono_sylius_navigation.ui.add_item'|trans }}
                    <i class="dropdown icon"></i>
                    <div class="menu">
                        <!-- Item types will be loaded dynamically by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="ui divider"></div>

            <div class="ui fluid icon input" style="margin-bottom: 1rem;">
                <input type="text" id="tree-search" placeholder="{{ 'sylius.ui.search'|trans }}...">
                <i class="search icon"></i>
            </div>

            <div id="navigation-tree-container">
                <div id="navigation-tree" class="ui relaxed divided list">
                    <!-- Tree will be loaded here via JavaScript -->
                </div>

                <div id="tree-loading" class="ui active centered inline loader" style="display: none;">
                    {{ 'sylius.ui.loading'|trans }}
                </div>

                <div id="empty-tree" class="ui placeholder segment" style="display: none;">
                    <div class="ui icon header">
                        <i class="sitemap icon"></i>
                        {{ 'setono_sylius_navigation.ui.empty_navigation'|trans }}
                    </div>
                    <div class="inline">
                        <div id="empty-add-dropdown" class="ui primary button dropdown">
                            <i class="plus icon"></i>
                            {{ 'setono_sylius_navigation.ui.add_first_item'|trans }}
                            <i class="dropdown icon"></i>
                            <div class="menu">
                                <!-- Item types will be loaded dynamically by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="six wide column">
        <!-- Item Information Panel (shown when item is selected) -->
        <div id="item-info-panel" class="ui segment" style="display: none;">
            <h3 class="ui dividing header">
                <i class="info circle icon"></i>
                {{ 'setono_sylius_navigation.ui.item_information'|trans }}
            </h3>
            <div id="item-info-content">
                <div class="ui active centered inline loader">{{ 'sylius.ui.loading'|trans }}</div>
            </div>
        </div>

        <!-- Navigation Information Panel (default view) -->
        <div id="navigation-info-panel" class="ui segment">
            <h3 class="ui dividing header">
                <i class="info circle icon"></i>
                {{ 'sylius.ui.information'|trans }}
            </h3>
            <div class="ui list">
                <div class="item">
                    {% if navigation.enabled %}
                        <i class="green check circle icon"></i>
                        <div class="content"><strong>{{ 'sylius.ui.enabled'|trans }}</strong></div>
                    {% else %}
                        <i class="red times circle icon"></i>
                        <div class="content"><strong>{{ 'sylius.ui.disabled'|trans }}</strong></div>
                    {% endif %}
                </div>
                <div class="item">
                    <strong>{{ 'sylius.ui.code'|trans }}:</strong> {{ navigation.code }}
                </div>
                <div class="item">
                    <strong>{{ 'sylius.ui.description'|trans }}:</strong> {{ navigation.description ?? 'N/A' }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal (simplified - only shows form after type selection) -->
<div id="add-item-modal" class="ui modal">
    <div class="header">
        <i class="plus icon"></i>
        <span id="add-item-modal-title">{{ 'setono_sylius_navigation.ui.add_new_item'|trans }}</span>
    </div>
    <div class="content">
        <div id="add-item-form-fields">
            <!-- Form fields will be loaded dynamically via AJAX -->
        </div>
    </div>
    <div class="actions">
        <div class="ui cancel button">
            {{ 'sylius.ui.cancel'|trans }}
        </div>
        <div class="ui primary button" onclick="NavigationBuilder.addItem()">
            {{ 'sylius.ui.create'|trans }}
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div id="edit-item-modal" class="ui modal">
    <div class="header">
        <i class="edit icon"></i>
        {{ 'setono_sylius_navigation.ui.edit_item'|trans }}
    </div>
    <div class="content">
        <div id="edit-item-form-fields">
            <!-- Form fields will be loaded dynamically via AJAX -->
        </div>
    </div>
    <div class="actions">
        <div class="ui cancel button">
            {{ 'sylius.ui.cancel'|trans }}
        </div>
        <div class="ui primary button" onclick="NavigationBuilder.updateItem()">
            {{ 'sylius.ui.save'|trans }}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-item-modal" class="ui basic modal">
    <div class="ui icon header">
        <i class="trash icon"></i>
        {{ 'setono_sylius_navigation.ui.delete_item'|trans }}
    </div>
    <div class="content">
        <p>{{ 'setono_sylius_navigation.ui.delete_item_confirmation'|trans }}</p>
        <input type="hidden" id="delete-item-id">
    </div>
    <div class="actions">
        <div class="ui red basic cancel inverted button">
            <i class="remove icon"></i>
            {{ 'sylius.ui.no_label'|trans }}
        </div>
        <div class="ui green ok inverted button" onclick="NavigationBuilder.deleteItem()">
            <i class="checkmark icon"></i>
            {{ 'sylius.ui.yes_label'|trans }}
        </div>
    </div>
</div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/themes/default/style.min.css" />
    <link rel="stylesheet" href="{{ asset('bundles/setonosyliusnavigationplugin/css/navigation-builder.css') }}">
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/jstree.min.js"></script>
    <script>
        window.NavigationBuilderConfig = {
            navigationId: {{ navigation.id }},
            routes: {
                getTree: '{{ path('setono_sylius_navigation_admin_navigation_build_get_tree', {'navigation': navigation.id}) }}',
                searchItems: '{{ path('setono_sylius_navigation_admin_navigation_build_search_items', {'navigation': navigation.id}) }}',
                getItemTypes: '{{ path('setono_sylius_navigation_admin_navigation_build_get_item_types') }}',
                getForm: '{{ path('setono_sylius_navigation_admin_navigation_build_get_form', {'type': '__TYPE__'}) }}',
                addItem: '{{ path('setono_sylius_navigation_admin_navigation_build_add_item', {'navigation': navigation.id}) }}',
                updateItem: '{{ path('setono_sylius_navigation_admin_navigation_build_update_item', {'navigation': navigation.id, 'item': '__ITEM_ID__'}) }}',
                deleteItem: '{{ path('setono_sylius_navigation_admin_navigation_build_delete_item', {'navigation': navigation.id, 'item': '__ITEM_ID__'}) }}',
                reorderItem: '{{ path('setono_sylius_navigation_admin_navigation_build_reorder_item', {'navigation': navigation.id}) }}',
                getItemInfo: '{{ path('setono_sylius_navigation_admin_navigation_build_get_item_info', {'navigation': navigation.id, 'item': '__ITEM_ID__'}) }}',
                getTaxons: '{{ path('sylius_admin_ajax_taxon_by_name_phrase') }}' {# Using existing Sylius route for taxon search #}
            },
            translations: {
                loading: '{{ 'sylius.ui.loading'|trans }}',
                error: '{{ 'sylius.ui.error'|trans }}',
                success: '{{ 'sylius.ui.success'|trans }}',
                simpleItem: '{{ 'setono_sylius_navigation.ui.simple_item'|trans }}',
                taxonItem: '{{ 'setono_sylius_navigation.ui.taxon_item'|trans }}'
            }
        };
    </script>
    <script type="module" src="{{ asset('bundles/setonosyliusnavigationplugin/js/navigation-builder.js') }}?v={{ 'now'|date('U') }}"></script>
{% endblock %}
